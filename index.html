<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shopping List</title>
    <link rel="stylesheet" href="css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico">
<!--    <link rel="manifest" href="manifest.json"> -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#820185">
</head>
<body>
    <div class="shopping-list">
        <header class="shopping-list-header">
            <h1>Couch Shopping</h1>
        </header>

        <main class="shopping-list-main">
            <section class="shopping-list-section">
                <ul id="itemList" class="shopping-list-list">
                </ul>
            </section>

        </main>
    </div>

    <!-- <script src="js/register-service-worker.js"></script> -->
    <script src="js/screenOrientation.js"></script>

    <script>
        let path="/_all_dbs";

        function completed(dbList) {
          console.log("Called completed");
          let list = document.getElementById('itemList');

          for (let i = 0; i < dbList.length; i++) {
            let li = document.createElement("li");
            li.style.margin = '10px';
            let a = document.createElement('a');
            a.href =  'shop.html?store=' + dbList[i];
            a.innerHTML = dbList[i];
            a.style.padding = '10px';
            li.appendChild(a);
            list.appendChild(li);
            console.log("DBName = ", dbList[i]);
          }
        }

        function invalidResponse() {
            console.log("Called invalidResp");
            let db_url = window.localStorage.getItem('db_url');
            db_url = window.prompt('Enter Couch DB URL for Couch Shopping:', db_url);
            window.localStorage.setItem('db_url', db_url);
            checker();
        }

        function isArray(what) {
          return Object.prototype.toString.call(what) === '[object Array]';
        }

        function checker() {
          console.log("Called checker2");
          let storedURL = window.localStorage.getItem('db_url')
          if (null == storedURL) {
            window.location.replace('/configure.html')
          }
          console.log('stored url', storedURL)
          let asURL = new URL(storedURL);
          let userid = asURL.username;
          let password = asURL.password;
          let host = asURL.host;
          console.log('userid', userid, 'password', password)
          let protocol = asURL.protocol
          let auth = ((userid === undefined) || (password === undefined)) ? ':' : userid + ':' + password;
          let url = protocol + '//' + host + path;
          let response = fetch(url, {method: 'GET',
                                     credentials: 'same-origin',
                                     redirect: 'follow',
                                     agent: null,
                                     headers: {
                                       "Content-Type": "text/plain",
                                       'Authorization': 'Basic ' + btoa(auth)
                                     },
                                     timeout: 5000})
                                .then(response => {
                                       response.json().then(json => {
                                         if (isArray(json)) {
                                           completed(json);
                                         } else {
                                           invalidResponse();
                                         }
                                       });
                                     });
        }

        checker();

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function (e) { deferredPrompt = e; showAddToHomeScreen(); });

    </script>
</body>
</html>
